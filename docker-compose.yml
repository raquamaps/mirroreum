fs:
  image: tianon/true
  volumes:
    - ./src:/home/rstudio:rw
    - ./src/jekyll/:/src:rw
    - ./shr/dynamic:/srv/shiny-server:rw
    - ./shr/static:/usr/share/nginx/html:rw

fs.jekyll:
  image: tianon/true
  volumes:
    - ./src/jekyll/_site:/usr/share/nginx/html:rw

fs.proxy:
  image: tianon/true
  volumes:
    - ./letsencrypt/certs:/etc/nginx/certs:ro
    - ./letsencrypt/conf:/etc/nginx/vhost.d
    - ./letsencrypt/html:/usr/share/nginx/html
    - /var/run/docker.sock:/tmp/docker.sock:ro

ropensci:
  build: eubon-rocker
  environment:
    - ENCRYPT_EMAIL=dina@mail.dina-web.net
    - ENCRYPT_HOST=wrangler.mirroreum.eu
    - VIRTUAL_HOST=wrangler.mirroreum.eu
    - VIRTUAL_PORT=8787
    - USER=rstudio
    - PASSWORD=rstudio
    - ROOT=TRUE
  ports:
    - "8787:8787"
  volumes_from:
    - fs

shiny:
  image: rocker/shiny
  environment:
    - ENCRYPT_EMAIL=dina@mail.dina-web.net
    - ENCRYPT_HOST=dynamic.mirroreum.eu
    - VIRTUAL_HOST=dynamic.mirroeum.eu
  ports:
    - "3737:3737"
  links:
    - ropensci
  volumes_from:
    - fs

nginx:
  image: nginx
  environment:
    - ENCRYPT_EMAIL=dina@mail.dina-web.net
    - ENCRYPT_HOST=static.mirroreum.eu
    - VIRTUAL_HOST=static.mirroreum.eu
  volumes_from:
    - fs

jekyll:
  image: grahamc/jekyll:next
  command: build --incremental -w
  ports:
    - "4000:4000"
  volumes_from:
    - fs

portal:
  image: nginx
  environment:
    - ENCRYPT_EMAIL=dina@mail.dina-web.net
    - ENCRYPT_HOST=mirroreum.eu,portal.mirroreum.eu,www.mirroreum.eu
    - VIRTUAL_HOST=mirroreum.eu,portal.mirroreum.eu,www.mirroreum.eu
  volumes_from:
    - fs.jekyll

proxy:
  image: jwilder/nginx-proxy
  container_name: proxy
  ports:
    - "80:80"
    - "443:443"
  volumes_from:
    - fs.proxy

letsencrypt:
  environment:
    - DEBUG=true
    - NGINX_PROXY_CONTAINER=proxy
  image: jrcs/letsencrypt-nginx-proxy-companion
  volumes_from:
    - fs.proxy
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock:ro
    - /letsencrypt/certs:/etc/nginx/certs:rw
